{% extends "base.html" %}

{% block title %}Rankings & Analysis - Malawi School Reporting System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h2><i class="fas fa-trophy me-2"></i>Student Rankings & Analysis</h2>
        <p class="text-muted">View student rankings and top performers analysis</p>
    </div>
</div>

<div class="row">
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">Analysis Parameters</h5>
            </div>
            <div class="card-body">
                <form id="analysisForm">
                    <div class="mb-3">
                        <label for="formLevel" class="form-label">Form Level</label>
                        <select class="form-select" id="formLevel" required>
                            <option value="1">Form 1</option>
                            <option value="2">Form 2</option>
                            <option value="3">Form 3</option>
                            <option value="4">Form 4</option>
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="termSelect" class="form-label">Term</label>
                        <select class="form-select" id="termSelect" required>
                            <option value="">Select term...</option>
                            {% for t in available_terms %}
                            <option value="{{ t }}" {% if t == selected_term %}selected{% endif %}>{{ t }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label for="academicYear" class="form-label">Academic Year</label>
                        <select id="academicYear" class="form-select" required>
                            <option value="">Select year...</option>
                            {% for y in available_years %}
                            <option value="{{ y }}" {% if y == selected_academic_year %}selected{% endif %}>{{ y }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button type="button" class="btn btn-warning" onclick="loadRankings()">
                            <i class="fas fa-list-ol me-2"></i>Load Rankings
                        </button>
                        <button type="button" class="btn btn-success" onclick="exportRankings()">
                            <i class="fas fa-file-excel me-2"></i>Export to Excel
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">Top Performers</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="loadTopPerformers('overall')">
                        <i class="fas fa-star me-1"></i>Best Overall
                    </button>
                    <button class="btn btn-outline-success btn-sm" onclick="loadTopPerformers('sciences')">
                        <i class="fas fa-flask me-1"></i>Best in Sciences
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="loadTopPerformers('humanities')">
                        <i class="fas fa-globe me-1"></i>Best in Humanities
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="loadTopPerformers('languages')">
                        <i class="fas fa-language me-1"></i>Best in Languages
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0">Rankings & Analysis Results</h5>
            </div>
            <div class="card-body">
                <div id="loadingSpinner" class="text-center d-none">
                    <div class="spinner-border text-warning" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Loading analysis...</p>
                </div>
                
                <div id="analysisResults">
                    <div class="text-center text-muted py-5">
                        <i class="fas fa-chart-bar fa-4x mb-3"></i>
                        <p>Select parameters and click "Load Rankings" to view analysis</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-12">
        <div class="alert alert-warning">
            <h6><i class="fas fa-info-circle me-2"></i>Analysis Categories</h6>
            <div class="row">
                <div class="col-md-3">
                    <strong>Overall Ranking:</strong>
                    <ul class="mb-0">
                        <li>Based on average marks</li>
                        <li>All subjects included</li>
                        <li>Position in class</li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <strong>Sciences:</strong>
                    <ul class="mb-0">
                        <li>Agriculture</li>
                        <li>Biology</li>
                        <li>Chemistry</li>
                        <li>Computer Studies</li>
                        <li>Mathematics</li>
                        <li>Physics</li>                        <li>Business Studies</li>
                        <li>Home Economics</li>                    </ul>
                </div>
                <div class="col-md-3">
                    <strong>Humanities:</strong>
                    <ul class="mb-0">
                        <li>Bible Knowledge</li>
                        <li>Geography</li>
                        <li>History</li>
                        <li>Life Skills/SOS</li>
                    </ul>
                </div>
                <div class="col-md-3">
                    <strong>Languages:</strong>
                    <ul class="mb-0">
                        <li>English</li>
                        <li>Chichewa</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
function _getSelectedValue(selectId, fallback) {
    const sel = document.getElementById(selectId);
    if (!sel) return fallback;
    let v = sel.value;
    if (v && v.trim() !== '') return v;
    // try to find an explicitly marked selected option
    const explicit = sel.querySelector('option[selected]');
    if (explicit && explicit.value) return explicit.value;
    // fallback to first non-empty option
    for (let i = 0; i < sel.options.length; i++) {
        if (sel.options[i].value && sel.options[i].value.trim() !== '') return sel.options[i].value;
    }
    return fallback;
}

function loadRankings() {
    const formLevel = document.getElementById('formLevel').value;
    const term = _getSelectedValue('termSelect', 'Term 1');
    const academicYear = _getSelectedValue('academicYear', '2025-2026');

    if (!formLevel) {
        alert('Please select a form level');
        return;
    }

    showLoading();

    fetch(`/api/rankings/${formLevel}?term=${encodeURIComponent(term)}&academic_year=${encodeURIComponent(academicYear)}`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        if (data.success && data.rankings) {
            displayRankings(data.rankings, formLevel);
        } else {
            document.getElementById('analysisResults').innerHTML = 
                '<div class="alert alert-danger">No ranking data found for the selected parameters</div>';
        }
    })
    .catch(error => {
        hideLoading();
        document.getElementById('analysisResults').innerHTML = 
            '<div class="alert alert-danger">Error loading rankings: ' + error.message + '</div>';
    });
}

function displayRankings(rankings, formLevel) {
    let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">Form ${formLevel} Student Rankings</h6>
            <div class="btn-group" role="group">
                <button class="btn btn-primary btn-sm" onclick="printRankings(${formLevel})">
                    <i class="fas fa-print me-1"></i>Print Rankings
                </button>
                <button class="btn btn-danger btn-sm" onclick="downloadRankingsPDF(${formLevel})">
                    <i class="fas fa-file-pdf me-1"></i>PDF
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped table-hover" id="rankingsTable">
                <thead class="table-dark">
                    <tr>
                        <th>Position</th>
                        <th>Student Name</th>
                        <th id="averageHeader">Average Mark</th>
                        <th id="gradeHeader">Grade</th>
                        <th id="aggregateHeader" style="display: none;">Aggregate Points</th>
                        <th>Subjects Passed</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Update headers based on form level
    if (formLevel >= 3) {
        // Forms 3&4: Hide average mark and grade, show aggregate points
        html = html.replace('id="averageHeader">Average Mark', 'id="averageHeader" style="display: none;">Average Mark');
        html = html.replace('id="gradeHeader">Grade', 'id="gradeHeader" style="display: none;">Grade');
        html = html.replace('id="aggregateHeader" style="display: none;">Aggregate Points', 'id="aggregateHeader">Aggregate Points');
    } else {
        // Forms 1&2: Hide average mark and aggregate points, show grade
        html = html.replace('id="averageHeader">Average Mark', 'id="averageHeader" style="display: none;">Average Mark');
    }
    
    rankings.forEach((student, index) => {
        const statusClass = student.status === 'PASS' ? 'text-success' : 'text-danger';
        
        // Display columns based on form level
        let averageCell, gradeCell, aggregateCell;
        
        if (formLevel <= 2) {
            averageCell = `<td style="display: none;"></td>`;
            const gradeClass = getGradeClass(student.grade, formLevel);
            gradeCell = `<td><span class="badge ${gradeClass}">${student.grade}</span></td>`;
            aggregateCell = `<td style="display: none;"></td>`;
        } else {
            averageCell = `<td style="display: none;"></td>`;
            gradeCell = `<td style="display: none;"></td>`;
            aggregateCell = `<td><span class="badge bg-info">${student.aggregate_points || 'N/A'}</span></td>`;
        }
        
        html += `
            <tr>
                <td><strong>${index + 1}</strong></td>
                <td>${student.name}</td>
                ${averageCell}
                ${gradeCell}
                ${aggregateCell}
                <td>${student.subjects_passed}/12</td>
                <td><span class="${statusClass}"><strong>${student.status}</strong></span></td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <div class="mt-3">
            <small class="text-muted">
                Total Students: ${rankings.length} | 
                Passed: ${rankings.filter(s => s.status === 'PASS').length} | 
                Failed: ${rankings.filter(s => s.status === 'FAIL').length}
            </small>
        </div>
    `;
    
    document.getElementById('analysisResults').innerHTML = html;
}

function loadTopPerformers(category) {
    const formLevel = document.getElementById('formLevel').value;
    const term = _getSelectedValue('termSelect', 'Term 1');
    const academicYear = _getSelectedValue('academicYear', '2025-2026');

    if (!formLevel) {
        alert('Please select a form level');
        return;
    }

    showLoading();

    fetch(`/api/top-performers/${formLevel}/${category}?term=${encodeURIComponent(term)}&academic_year=${encodeURIComponent(academicYear)}`, {
        method: 'GET',
        headers: { 'Content-Type': 'application/json' }
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        console.log('Top Performers API Response:', data); // Debug logging
        if (data.success && data.performers) {
            console.log('Performers data:', data.performers); // Debug logging
            displayTopPerformers(data.performers, category, formLevel);
        } else {
            console.log('No performers data or API failed'); // Debug logging
            document.getElementById('analysisResults').innerHTML = 
                '<div class="alert alert-warning">No top performers data found for ' + category + '</div>';
        }
    })
    .catch(error => {
        hideLoading();
        document.getElementById('analysisResults').innerHTML = 
            '<div class="alert alert-danger">Error loading top performers: ' + error.message + '</div>';
    });
}

function displayTopPerformers(performers, category, formLevel) {
    console.log('displayTopPerformers called with:', { performers, category, formLevel }); // Debug logging
    
    const categoryTitles = {
        'overall': 'Best Overall Students',
        'sciences': 'Best in Sciences Department',
        'humanities': 'Best in Humanities Department',
        'languages': 'Best in Languages Department'
    };
    
    let html = `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="mb-0">${categoryTitles[category]} - Form ${formLevel}</h6>
            <div class="btn-group" role="group">
                <button class="btn btn-primary btn-sm" onclick="printTopPerformers('${category}', ${formLevel})">
                    <i class="fas fa-print me-1"></i>Print
                </button>
                <button class="btn btn-danger btn-sm" onclick="downloadTopPerformersPDF('${category}', ${formLevel})">
                    <i class="fas fa-file-pdf me-1"></i>PDF
                </button>
            </div>
        </div>
        <div class="table-responsive">
            <table class="table table-striped" id="topPerformersTable">
                <thead class="table-primary">
                    <tr>
                        <th>Rank</th>
                        <th>Student Name</th>
                        <th>Overall %</th>
                        <th style="display: none;">${parseInt(formLevel) <= 2 ? 'Grade' : 'Aggregate Points'}</th>
                        <th>Excellence Area</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    performers.slice(0, 10).forEach((student, index) => {
        let displayValue, gradeClass = 'bg-primary';
        
        if (category === 'overall') {
            if (parseInt(formLevel) >= 3 && student.aggregate_points !== null) {
                displayValue = student.aggregate_points;
                if (displayValue <= 12) gradeClass = 'bg-success';
                else if (displayValue <= 18) gradeClass = 'bg-primary';
                else if (displayValue <= 24) gradeClass = 'bg-info';
                else if (displayValue <= 30) gradeClass = 'bg-warning';
                else gradeClass = 'bg-danger';
            } else {
                displayValue = student.grade;
                gradeClass = getGradeClass(student.grade, formLevel);
            }
        } else {
            // For department-specific categories show the department total and department average
            const deptTotal = student.department_total || 0;
            const deptAvg = student.department_average || 0;
            displayValue = `${deptTotal} (avg ${deptAvg.toFixed(1)}%)`;
            if (deptAvg >= 80) gradeClass = 'bg-success';
            else if (deptAvg >= 70) gradeClass = 'bg-primary';
            else if (deptAvg >= 60) gradeClass = 'bg-info';
            else if (deptAvg >= 50) gradeClass = 'bg-warning';
            else gradeClass = 'bg-danger';
        }
        
        html += `
            <tr>
                <td>
                    ${index < 3 ? 
                        `<i class="fas fa-trophy text-${index === 0 ? 'warning' : index === 1 ? 'secondary' : 'warning'}"></i> ` : 
                        ''
                    }
                    <strong>${index + 1}</strong>
                </td>
                <td>${student.name}</td>
                <td><span class="badge ${gradeClass}">${displayValue}</span></td>
                <td style="display: none;"></td>
                <td>${student.excellence_area || category.charAt(0).toUpperCase() + category.slice(1)}${student.subjects_taken ? ` (subjects: ${student.subjects_taken})` : ''}</td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
    `;
    
    document.getElementById('analysisResults').innerHTML = html;
}

function getGradeClass(grade, formLevel) {
    if (parseInt(formLevel) <= 2) {
        // Junior forms
        switch(grade) {
            case 'A': return 'bg-success';
            case 'B': return 'bg-primary';
            case 'C': return 'bg-info';
            case 'D': return 'bg-warning';
            case 'F': return 'bg-danger';
            default: return 'bg-secondary';
        }
    } else {
        // Senior forms
        const gradeNum = parseInt(grade);
        if (gradeNum <= 2) return 'bg-success';
        else if (gradeNum <= 4) return 'bg-primary';
        else if (gradeNum <= 6) return 'bg-info';
        else if (gradeNum <= 8) return 'bg-warning';
        else return 'bg-danger';
    }
}



function printTopPerformers(category, formLevel) {
    const table = document.getElementById('topPerformersTable');
    if (!table) {
        alert('No data to print');
        return;
    }
    
    // Create a new window for printing
    const printWindow = window.open('', '_blank');
    const categoryTitles = {
        'overall': 'Best Overall Students',
        'sciences': 'Best in Sciences Department',
        'humanities': 'Best in Humanities Department',
        'languages': 'Best in Languages Department'
    };
    
    const gradeColumnHeader = parseInt(formLevel) <= 2 ? 'Average Grade' : 'Aggregate Points';
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Top Performers - ${categoryTitles[category]} Form ${formLevel}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; font-weight: bold; }
                .trophy { color: #ffc107; }
                h2 { color: #333; text-align: center; }
                @media print { .no-print { display: none; } }
            </style>
        </head>
        <body>
            <h2>${categoryTitles[category]} - Form ${formLevel}</h2>
            <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
            <p><strong>Note:</strong> ${gradeColumnHeader} column shows ${parseInt(formLevel) <= 2 ? 'average grade (A-F)' : 'aggregate points (sum of best 6 subjects)'}</p>
            ${table.outerHTML}
            <div class="no-print" style="margin-top: 20px; text-align: center;">
                <button onclick="window.print()">Print Report</button>
                <button onclick="window.close()">Close</button>
            </div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
}

function printRankings(formLevel) {
    const table = document.getElementById('rankingsTable');
    if (!table) {
        alert('No rankings data to print');
        return;
    }
    
    // Create a new window for printing
    const printWindow = window.open('', '_blank');
    const gradeColumnHeader = parseInt(formLevel) <= 2 ? 'Grade' : 'Aggregate Points';
    
    printWindow.document.write(`
        <!DOCTYPE html>
        <html>
        <head>
            <title>Student Rankings - Form ${formLevel}</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                table { border-collapse: collapse; width: 100%; margin-top: 20px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; font-weight: bold; }
                .text-success { color: #28a745; font-weight: bold; }
                .text-danger { color: #dc3545; font-weight: bold; }
                h2 { color: #333; text-align: center; }
                @media print { .no-print { display: none; } }
            </style>
        </head>
        <body>
            <h2>Form ${formLevel} Student Rankings</h2>
            <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
            <p><strong>Note:</strong> ${gradeColumnHeader} column shows ${parseInt(formLevel) <= 2 ? 'average grade (A-F)' : 'aggregate points (sum of best 6 subjects)'}</p>
            ${table.outerHTML}
            <div class="no-print" style="margin-top: 20px; text-align: center;">
                <button onclick="window.print()">Print Report</button>
                <button onclick="window.close()">Close</button>
            </div>
        </body>
        </html>
    `);
    
    printWindow.document.close();
}

function exportRankings() {
    const formLevel = document.getElementById('formLevel').value;
    const term = _getSelectedValue('termSelect', 'Term 1');
    const academicYear = _getSelectedValue('academicYear', '2025-2026');

    if (!formLevel) {
        alert('Please select a form level');
        return;
    }
    
    showLoading();
    
    fetch('/api/export-rankings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            form_level: formLevel,
            term: term,
            academic_year: academicYear
        })
    })
    .then(response => {
        hideLoading();
        if (response.ok) {
            return response.blob();
        } else {
            return response.json().then(data => {
                throw new Error(data.message);
            });
        }
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `Form_${formLevel}_Rankings_${term}_${academicYear.replace('-', '_')}.xlsx`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showNotification('Rankings exported successfully!', 'success');
    })
    .catch(error => {
        alert('Export failed: ' + error.message);
    });
}

function showLoading() {
    document.getElementById('loadingSpinner').classList.remove('d-none');
    document.getElementById('analysisResults').innerHTML = '';
}

function hideLoading() {
    document.getElementById('loadingSpinner').classList.add('d-none');
}

function downloadTopPerformersPDF(category, formLevel) {
    const term = document.getElementById('termSelect').value;
    const academicYear = document.getElementById('academicYear').value;
    
    if (!formLevel || !term || !academicYear) {
        alert('Please ensure all fields are filled and data is loaded');
        return;
    }
    
    showLoading();
    
    fetch('/api/export-top-performers-pdf', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            category: category,
            form_level: formLevel,
            term: term,
            academic_year: academicYear
        })
    })
    .then(response => {
        hideLoading();
        if (response.ok) {
            return response.blob();
        } else {
            return response.json().then(data => {
                throw new Error(data.message || 'Failed to generate PDF');
            });
        }
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `Top_Performers_${category}_Form_${formLevel}_${term}_${academicYear.replace('-', '_')}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showNotification('Top performers PDF downloaded successfully!', 'success');
    })
    .catch(error => {
        hideLoading();
        alert('PDF download failed: ' + error.message);
    });
}

function downloadRankingsPDF(formLevel) {
    const term = document.getElementById('termSelect').value;
    const academicYear = document.getElementById('academicYear').value;
    
    if (!formLevel || !term || !academicYear) {
        alert('Please ensure all fields are filled and data is loaded');
        return;
    }
    
    showLoading();
    
    fetch('/api/export-rankings-pdf', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            form_level: formLevel,
            term: term,
            academic_year: academicYear
        })
    })
    .then(response => {
        hideLoading();
        if (response.ok) {
            return response.blob();
        } else {
            return response.json().then(data => {
                throw new Error(data.message || 'Failed to generate PDF');
            });
        }
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        a.download = `Form_${formLevel}_Rankings_${term}_${academicYear.replace('-', '_')}.pdf`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
        
        showNotification('Rankings PDF downloaded successfully!', 'success');
    })
    .catch(error => {
        hideLoading();
        alert('PDF download failed: ' + error.message);
    });
}

function showNotification(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}
</script>
{% endblock %}