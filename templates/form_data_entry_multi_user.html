<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Form {{ form_level }} Data Entry - {{ school_name }}</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
    
    <style>
        .user-header {
            background: linear-gradient(135deg, var(--bs-primary) 0%, #0066cc 100%);
            color: white;
            padding: 1rem;
            border-radius: 10px 10px 0 0;
        }
        .conflict-indicator {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
        }
        .form-indicator {
            background: #28a745;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
        }
        .activity-indicator {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .user-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 15px;
            font-size: 0.85rem;
        }
        .subject-header-frozen {
            position: sticky;
            top: 0;
            z-index: 10;
            text-align: center;
            vertical-align: middle;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .subject-header-frozen:hover {
            background: linear-gradient(135deg, #5a6268 0%, #343a40 100%) !important;
            cursor: default;
        }
        .bg-danger-subtle {
            background-color: #fff5f5 !important;
        }
        .mark-input.border-danger {
            border-color: #dc3545 !important;
            border-width: 2px !important;
        }
    </style>
</head>
<body>
    <!-- User Header -->
    <div class="user-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-8">
                    <h4 class="mb-0">
                        <i class="fas fa-chalkboard-teacher me-2"></i>
                        Form {{ form_level }} Data Entry
                    </h4>
                    <p class="mb-0">
                        <i class="fas fa-user me-1"></i>
                        {{ full_name }} | 
                        <i class="fas fa-school me-1"></i>
                        {{ school_name }}
                    </p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="user-badge">
                        <i class="fas fa-shield-alt me-1"></i>
                        Protected Access
                    </div>
                    <div class="form-indicator mt-2">
                        <i class="fas fa-lock me-1"></i>
                        Form {{ form_level }} Locked to You
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-secondary">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('multi_user_dashboard') }}">
                <i class="fas fa-arrow-left me-2"></i>
                Back to Dashboard
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="{{ url_for('logout') }}">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
        </div>
    </nav>

    <div class="container mt-4" data-user-id="{{ session.school_user_id if session.school_user_id else 'null' }}" data-form-level="{{ form_level }}">
        <!-- Form Controls -->
        <div class="form-controls-section">
            <div class="row align-items-end">
                <div class="col-md-3">
                    <label for="termSelect" class="form-label fw-bold text-primary">
                        <i class="fas fa-calendar-alt me-1"></i>Term
                    </label>
                    <select id="termSelect" class="form-select">
                        {% for t in terms %}
                        <option value="{{ t }}" {% if t == selected_term %}selected{% endif %}>{{ t }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="yearSelect" class="form-label fw-bold text-primary">
                        <i class="fas fa-graduation-cap me-1"></i>Academic Year
                    </label>
                    <select id="yearSelect" class="form-select">
                        {% for y in academic_years %}
                        <option value="{{ y }}" {% if y == selected_academic_year %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <div class="d-flex gap-2">
                        <button class="btn btn-primary" onclick="loadAllMarks()">
                            <i class="fas fa-download me-1"></i>Load Existing Marks
                        </button>
                        <button class="btn btn-success" onclick="saveAllMarks()">
                            <i class="fas fa-save me-1"></i>Save All Marks
                        </button>
                        <button class="btn btn-info" onclick="refreshData()">
                            <i class="fas fa-sync me-1"></i>Refresh
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Status -->
        <div class="alert alert-success mt-3">
            <div class="d-flex align-items-center">
                <div class="activity-indicator me-3">
                    <i class="fas fa-circle text-success"></i>
                </div>
                <div>
                    <strong>Active Session</strong><br>
                    <small>You have exclusive access to Form {{ form_level }}. Other users cannot modify this form while you're working.</small>
                </div>
            </div>
        </div>

        <!-- Students Table -->
        <div class="table-responsive mt-2">
            <table class="table table-striped table-hover table-sm" id="marksTable">
                <!-- Main Table Headers (scrollable) -->
                <thead class="table-dark">
                    <tr>
                        <th style="width: 5%; font-size: 0.85rem; padding: 0.4rem;">#</th>
                        <th style="width: 20%; font-size: 0.85rem; padding: 0.4rem;">Student Name</th>
                        {% for subject in subjects|sort %}
                        <th class="subject-column" style="font-size: 0.85rem; padding: 0.4rem;">{{ subject }}</th>
                        {% endfor %}
                        <th style="width: 20%; font-size: 0.85rem; padding: 0.4rem;">Actions</th>
                    </tr>
                </thead>
                
                <!-- Frozen Subject Names Row (sticky) -->
                <thead class="table-info" style="position: sticky; top: 0; z-index: 10;">
                    <tr>
                        <th style="width: 5%; background: transparent; border: none; padding: 0.2rem;"></th>
                        <th style="width: 20%; background: transparent; border: none; padding: 0.2rem;"></th>
                        {% for subject in subjects|sort %}
                        <th class="subject-header-frozen text-center" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; font-weight: bold; padding: 0.3rem; border: 1px solid #495057; font-size: 0.8rem;">
                            {{ subject }}
                        </th>
                        {% endfor %}
                        <th class="text-center" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); color: white; font-weight: bold; padding: 0.3rem; border: 1px solid #495057; font-size: 0.8rem;">
                            Actions
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% if students %}
                    {% for student in students %}
                    <tr data-student-id="{{ student.student_id }}" class="{% if loop.index0 % 2 == 0 %}table-light{% else %}table-white{% endif %}">
                        <td class="text-center" style="width: 50px;">
                            <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 25px; height: 25px; font-size: 0.75rem; font-weight: bold;">
                                {{ loop.index }}
                            </div>
                        </td>
                        <td class="student-name-column">
                            <div class="compact-name">
                                <strong class="text-dark">{{ student.first_name }} {{ student.last_name }}</strong><br>
                                <small class="text-muted compact-id">ID: {{ student.student_id }}</small>
                            </div>
                        </td>
                        {% for subject in subjects|sort %}
                        <td class="text-center subject-column">
                            <input type="number" 
                                   class="form-control form-control-sm mark-input" 
                                   id="mark_{{ student.student_id }}_{{ subject|replace(' ', '_')|replace('/', '_') }}"
                                   min="0" max="100" 
                                   placeholder="0-100"
                                   data-student-id="{{ student.student_id }}"
                                   data-subject="{{ subject }}">
                        </td>
                        {% endfor %}
                        <td class="text-center" style="width: 20%;">
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn btn-outline-warning btn-sm" 
                                        onclick="editStudent('{{ student.student_id }}')"
                                        title="Edit {{ student.first_name }} {{ student.last_name }}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-outline-danger btn-sm" 
                                        onclick="deleteStudent('{{ student.student_id }}', '{{ student.first_name }} {{ student.last_name }}')"
                                        title="Delete {{ student.first_name }} {{ student.last_name }}">
                                    <i class="fas fa-trash"></i>
                                </button>
                                <button class="btn btn-outline-info btn-sm" 
                                        onclick="printReportCard('{{ student.student_id }}', '{{ student.first_name }} {{ student.last_name }}')"
                                        title="Print report card for {{ student.first_name }} {{ student.last_name }}">
                                    <i class="fas fa-print"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="{{ subjects|length + 2 }}" class="text-center py-5">
                            <div class="text-muted">
                                <i class="fas fa-graduation-cap fa-3x mb-3 text-primary"></i>
                                <h5 class="text-primary">New Academic Year - No Students Enrolled Yet</h5>
                                <p class="mb-3">
                                    This appears to be a new academic year/term. Students need to be enrolled for Form {{ form_level }} 
                                    before marks can be entered.
                                </p>
                                <div class="d-flex justify-content-center gap-2">
                                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addStudentModal">
                                        <i class="fas fa-user-plus me-1"></i>Enroll First Student
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="location.reload()">
                                        <i class="fas fa-sync me-1"></i>Refresh Page
                                    </button>
                                </div>
                            </div>
                        </td>
                    </tr>
                    {% endif %}
                </tbody>
                <tfoot>
                    <tr class="table-light">
                        <td colspan="{{ subjects|length + 2 }}" class="text-end">
                            <strong class="text-primary">
                                <i class="fas fa-users me-1"></i>Total Learners: {{ students|length }}
                            </strong>
                        </td>
                    </tr>
                </tfoot>
            </table>
        </div>

        <!-- User Activity Log -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-info text-white">
                        <h6 class="mb-0">
                            <i class="fas fa-history me-2"></i>
                            Your Recent Activity
                        </h6>
                    </div>
                    <div class="card-body">
                        <div id="activityLog">
                            <div class="text-center text-muted">
                                <i class="fas fa-spinner fa-spin"></i>
                                Loading activity log...
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Conflict Indicator (Hidden by default) -->
    <div id="conflictIndicator" class="conflict-indicator" style="display: none;">
        <div class="alert alert-warning alert-dismissible">
            <h6 class="alert-heading">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Access Conflict Detected
            </h6>
            <p class="mb-2">Another user is trying to access this form. Your session has priority.</p>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Get variables from data attributes
        const container = document.querySelector('.container');
        let formLevel = parseInt(container.dataset.formLevel);
        let userId = container.dataset.userId === 'null' ? null : parseInt(container.dataset.userId);
        let activityCheckInterval;
        let lastActivityTime = new Date();
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadActivityLog();
            startActivityMonitoring();
            
            // Auto-save every 5 minutes
            setInterval(autoSave, 300000);
            
            // Warn before leaving page
            window.addEventListener('beforeunload', function(e) {
                if (hasUnsavedChanges()) {
                    e.preventDefault();
                    e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
                }
            });
        });
        
        // Activity monitoring
        function startActivityMonitoring() {
            activityCheckInterval = setInterval(() => {
                checkForConflicts();
                updateLastActivity();
            }, 30000); // Check every 30 seconds
        }
        
        function updateLastActivity() {
            lastActivityTime = new Date();
            
            // Send heartbeat to server
            fetch('/api/user-heartbeat', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: userId,
                    form_level: formLevel,
                    activity: 'active'
                })
            }).catch(error => {
                console.error('Heartbeat failed:', error);
            });
        }
        
        function checkForConflicts() {
            fetch('/api/check-form-conflicts', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    user_id: userId,
                    form_level: formLevel
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.conflict) {
                    showConflictWarning(data.conflict_info);
                }
            })
            .catch(error => {
                console.error('Conflict check failed:', error);
            });
        }
        
        function showConflictWarning(conflictInfo) {
            const indicator = document.getElementById('conflictIndicator');
            indicator.style.display = 'block';
            
            // Auto-hide after 10 seconds
            setTimeout(() => {
                indicator.style.display = 'none';
            }, 10000);
        }
        
        function loadActivityLog() {
            fetch(`/api/user-activity/${userId}`)
                .then(response => response.json())
                .then(data => {
                    const logDiv = document.getElementById('activityLog');
                    
                    if (data.activities && data.activities.length > 0) {
                        logDiv.innerHTML = data.activities.map(activity => `
                            <div class="d-flex justify-content-between align-items-center py-2 border-bottom">
                                <div>
                                    <strong>${activity.activity_type}</strong>
                                    ${activity.form_level ? `- Form ${activity.form_level}` : ''}
                                </div>
                                <small class="text-muted">${new Date(activity.timestamp).toLocaleString()}</small>
                            </div>
                        `).join('');
                    } else {
                        logDiv.innerHTML = '<p class="text-muted mb-0">No recent activity</p>';
                    }
                })
                .catch(error => {
                    document.getElementById('activityLog').innerHTML = 
                        '<p class="text-danger mb-0">Error loading activity log</p>';
                });
        }
        
        function hasUnsavedChanges() {
            const inputs = document.querySelectorAll('.mark-input');
            for (let input of inputs) {
                if (input.value && input.value !== input.defaultValue) {
                    return true;
                }
            }
            return false;
        }
        
        function autoSave() {
            if (hasUnsavedChanges()) {
                console.log('Auto-saving changes...');
                saveAllMarks(false); // Silent save
            }
        }
        
        function refreshData() {
            if (hasUnsavedChanges()) {
                if (confirm('You have unsaved changes. Are you sure you want to refresh?')) {
                    location.reload();
                }
            } else {
                location.reload();
            }
        }
        
        // Reuse existing functions from original template
        function loadAllMarks() {
            const term = document.getElementById('termSelect').value;
            const academicYear = document.getElementById('yearSelect').value;
            
            const rows = document.querySelectorAll('#marksTable tbody tr');
            let loadedCount = 0;
            
            rows.forEach(row => {
                const studentId = row.getAttribute('data-student-id');
                
                fetch(`/api/load-student-marks?student_id=${studentId}&term=${encodeURIComponent(term)}&academic_year=${encodeURIComponent(academicYear)}`, {
                    method: 'GET',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.marks) {
                        Object.keys(data.marks).forEach(subject => {
                            const input = row.querySelector(`input[data-subject="${subject}"]`);
                            if (input) {
                                input.value = data.marks[subject];
                                input.classList.add('border-success');
                                input.style.backgroundColor = '#f8fff8';
                            }
                        });
                        loadedCount++;
                    }
                });
            });
            
            showNotification(`Loading marks for ${rows.length} students...`, 'info');
        }
        
        function saveAllMarks(showNotification = true) {
            const rows = document.querySelectorAll('#marksTable tbody tr');
            let hasInvalidMarks = false;
            let invalidMarkInfo = [];
            let savePromises = [];
            
            rows.forEach(row => {
                const studentId = row.getAttribute('data-student-id');
                const marks = {};
                let studentHasInvalidMarks = false;
                
                row.querySelectorAll('.mark-input').forEach(input => {
                    const subject = input.getAttribute('data-subject');
                    const value = input.value.trim();
                    
                    if (value) {
                        const markValue = parseInt(value);
                        
                        // Validate mark is between 0-100
                        if (isNaN(markValue) || markValue < 0 || markValue > 100) {
                            hasInvalidMarks = true;
                            studentHasInvalidMarks = true;
                            invalidMarkInfo.push({
                                studentId: studentId,
                                subject: subject,
                                mark: value,
                                studentName: row.querySelector('.student-name-column strong').textContent
                            });
                            
                            // Highlight invalid input
                            input.classList.add('border-danger');
                            input.classList.add('bg-danger-subtle');
                        } else {
                            marks[subject] = markValue;
                            
                            // Clear any previous error styling
                            input.classList.remove('border-danger');
                            input.classList.remove('bg-danger-subtle');
                        }
                    }
                });
                
                // Save valid marks for this student (even if other students have invalid marks)
                if (Object.keys(marks).length > 0 && !studentHasInvalidMarks) {
                    const term = document.getElementById('termSelect').value;
                    const academicYear = document.getElementById('yearSelect').value;
                    
                    const savePromise = fetch('/api/save-student-marks', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            student_id: studentId,
                            marks: marks,
                            term: term,
                            academic_year: academicYear,
                            form_level: formLevel
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            // Update input styling
                            row.querySelectorAll('.mark-input').forEach(input => {
                                input.classList.remove('border-danger');
                                input.classList.add('border-success');
                                input.defaultValue = input.value;
                            });
                            return { success: true, studentId: studentId };
                        } else {
                            return { success: false, studentId: studentId, error: data.message };
                        }
                    })
                    .catch(error => {
                        console.error('Save error:', error);
                        return { success: false, studentId: studentId, error: error.message };
                    });
                    
                    savePromises.push(savePromise);
                }
            });
            
            // Wait for all saves to complete
            Promise.all(savePromises).then(results => {
                const savedCount = results.filter(r => r.success).length;
                const failedSaves = results.filter(r => !r.success);
                
                if (hasInvalidMarks && savedCount > 0) {
                    // Show mixed success/error message
                    let errorMessage = `Successfully saved marks for ${savedCount} student(s).\n\n`;
                    errorMessage += 'Marks Exceed Normal Range:\n\n';
                    invalidMarkInfo.forEach(info => {
                        errorMessage += `${info.studentName} - ${info.subject}: ${info.mark} (must be 0-100)\n`;
                    });
                    errorMessage += '\nPlease correct these marks and save again.';
                    
                    showNotification(errorMessage, 'warning');
                    
                    // Scroll to first invalid mark
                    const firstInvalidInput = document.querySelector('.mark-input.border-danger');
                    if (firstInvalidInput) {
                        firstInvalidInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstInvalidInput.focus();
                    }
                } else if (hasInvalidMarks) {
                    // Show only error message
                    let errorMessage = 'Marks Exceed Normal Range:\n\n';
                    invalidMarkInfo.forEach(info => {
                        errorMessage += `${info.studentName} - ${info.subject}: ${info.mark} (must be 0-100)\n`;
                    });
                    errorMessage += '\nPlease correct these marks before saving.';
                    
                    showNotification(errorMessage, 'danger');
                    
                    // Scroll to first invalid mark
                    const firstInvalidInput = document.querySelector('.mark-input.border-danger');
                    if (firstInvalidInput) {
                        firstInvalidInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstInvalidInput.focus();
                    }
                } else if (savedCount > 0) {
                    showNotification(`Successfully saved marks for ${savedCount} student(s)`, 'success');
                } else if (savePromises.length === 0) {
                    showNotification('No marks to save. Please enter some marks first.', 'info');
                } else {
                    showNotification('Failed to save marks. Please try again.', 'danger');
                }
            });
            
            updateLastActivity();
        }
        
        function editStudent(studentId) {
            // Find the student row
            const row = document.querySelector(`tr[data-student-id="${studentId}"]`);
            if (!row) return;
            
            // Get current student name
            const nameCell = row.querySelector('.student-name-column');
            const nameElement = nameCell.querySelector('strong');
            const currentName = nameElement.textContent;
            
            // Create edit modal if it doesn't exist
            let editModal = document.getElementById('editStudentModal');
            if (!editModal) {
                const modalHtml = `
                    <div class="modal fade" id="editStudentModal" tabindex="-1">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title">Edit Student Name</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                </div>
                                <div class="modal-body">
                                    <form id="editStudentForm">
                                        <div class="mb-3">
                                            <label for="editFirstName" class="form-label">First Name</label>
                                            <input type="text" class="form-control" id="editFirstName" required>
                                        </div>
                                        <div class="mb-3">
                                            <label for="editLastName" class="form-label">Last Name</label>
                                            <input type="text" class="form-control" id="editLastName" required>
                                        </div>
                                        <input type="hidden" id="editStudentId">
                                    </form>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                                    <button type="button" class="btn btn-primary" onclick="saveStudentName()">Save Changes</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                editModal = document.getElementById('editStudentModal');
            }
            
            // Parse current name into first and last name
            const nameParts = currentName.trim().split(' ');
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';
            
            // Populate form fields
            document.getElementById('editFirstName').value = firstName;
            document.getElementById('editLastName').value = lastName;
            document.getElementById('editStudentId').value = studentId;
            
            // Show modal
            const modal = new bootstrap.Modal(editModal);
            modal.show();
            
            updateLastActivity();
        }
        
        function saveStudentName() {
            const studentId = document.getElementById('editStudentId').value;
            const firstName = document.getElementById('editFirstName').value.trim();
            const lastName = document.getElementById('editLastName').value.trim();
            
            if (!firstName || !lastName) {
                showNotification('Both first name and last name are required', 'danger');
                return;
            }
            
            fetch('/api/update-student-name', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    student_id: studentId,
                    first_name: firstName,
                    last_name: lastName,
                    form_level: formLevel
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update the student name in the table
                    const row = document.querySelector(`tr[data-student-id="${studentId}"]`);
                    if (row) {
                        const nameElement = row.querySelector('.student-name-column strong');
                        nameElement.textContent = `${firstName} ${lastName}`;
                        
                        // Update button title attributes
                        const editBtn = row.querySelector('button[onclick*="editStudent"]');
                        const deleteBtn = row.querySelector('button[onclick*="deleteStudent"]');
                        
                        if (editBtn) {
                            editBtn.setAttribute('title', `Edit ${firstName} ${lastName}`);
                        }
                        if (deleteBtn) {
                            deleteBtn.setAttribute('onclick', `deleteStudent('${studentId}', '${firstName} ${lastName}')`);
                            deleteBtn.setAttribute('title', `Delete ${firstName} ${lastName}`);
                        }
                    }
                    
                    // Hide modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('editStudentModal'));
                    modal.hide();
                    
                    showNotification(`Student name updated to ${firstName} ${lastName}`, 'success');
                } else {
                    showNotification(`Failed to update student name: ${data.message}`, 'danger');
                }
            })
            .catch(error => {
                showNotification(`Error updating student name: ${error}`, 'danger');
            });
            
            updateLastActivity();
        }
        
        function deleteStudent(studentId, studentName) {
            if (confirm(`Are you sure you want to delete ${studentName} and all their marks?\n\nThis action cannot be undone.`)) {
                fetch('/api/delete-student', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        student_id: studentId,
                        form_level: formLevel
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Remove the student row from the table
                        const row = document.querySelector(`tr[data-student-id="${studentId}"]`);
                        if (row) {
                            row.remove();
                        }
                        
                        // Update the total learners count
                        const totalLearnersElement = document.querySelector('tfoot strong');
                        if (totalLearnersElement) {
                            const currentCount = parseInt(totalLearnersElement.textContent.match(/\d+/)[0]);
                            totalLearnersElement.textContent = totalLearnersElement.textContent.replace(/\d+/, currentCount - 1);
                        }
                        
                        showNotification(`Successfully deleted ${studentName}`, 'success');
                    } else {
                        showNotification(`Failed to delete ${studentName}: ${data.message}`, 'danger');
                    }
                })
                .catch(error => {
                    showNotification(`Error deleting student: ${error}`, 'danger');
                });
                
                updateLastActivity();
            }
        }
        
        function printReportCard(studentId, studentName) {
            const term = document.getElementById('termSelect').value;
            const academicYear = document.getElementById('yearSelect').value;
            
            if (!term || !academicYear) {
                showNotification('Please select term and academic year first', 'warning');
                return;
            }
            
            // Show loading indicator
            const printBtn = document.querySelector(`button[onclick*="printReportCard('${studentId}'"]`);
            if (printBtn) {
                const originalContent = printBtn.innerHTML;
                printBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                printBtn.disabled = true;
                
                // Restore button after 3 seconds (fallback)
                setTimeout(() => {
                    printBtn.innerHTML = originalContent;
                    printBtn.disabled = false;
                }, 3000);
            }
            
            // Generate and download PDF report
            fetch('/api/export-report-card', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    student_id: studentId,
                    term: term,
                    academic_year: academicYear
                })
            })
            .then(response => {
                if (response.ok) {
                    // Extract filename from Content-Disposition header
                    const disposition = response.headers.get('Content-Disposition');
                    let filename = `Report_Card_${studentName.replace(' ', '_')}_${term}_${academicYear}.pdf`;
                    
                    if (disposition && disposition.includes('filename=')) {
                        filename = disposition.split('filename=')[1].replace(/"/g, '');
                    }
                    
                    return response.blob().then(blob => ({ blob, filename }));
                } else {
                    return response.json().then(data => {
                        throw new Error(data.message || 'PDF export failed');
                    });
                }
            })
            .then(({ blob, filename }) => {
                // Create download link
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
                
                showNotification(`Report card generated for ${studentName}`, 'success');
                
                // Restore button
                if (printBtn) {
                    printBtn.innerHTML = '<i class="fas fa-print"></i>';
                    printBtn.disabled = false;
                }
            })
            .catch(error => {
                console.error('Print error:', error);
                showNotification(`Failed to generate report card: ${error.message}`, 'danger');
                
                // Restore button
                if (printBtn) {
                    printBtn.innerHTML = '<i class="fas fa-print"></i>';
                    printBtn.disabled = false;
                }
            });
            
            updateLastActivity();
        }
        
        function showNotification(message, type) {
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            notification.style.top = '20px';
            notification.style.left = '50%';
            notification.style.transform = 'translateX(-50%)';
            notification.style.zIndex = '9999';
            notification.style.minWidth = '300px';
            
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            // Auto-remove after 3 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 3000);
        }
        
        // Subject focus and navigation functionality
        let currentSubjectIndex = -1; // -1 means all subjects
        let subjects = [];
        
        // Initialize subjects array
        document.addEventListener('DOMContentLoaded', function() {
            // Get subject names from table headers
            const subjectHeaders = document.querySelectorAll('.subject-column');
            subjects = Array.from(subjectHeaders).map(header => header.textContent.trim());
            
            // Add click handlers to subject headers
            subjectHeaders.forEach((header, index) => {
                header.style.cursor = 'pointer';
                header.title = `Click to focus on ${header.textContent.trim()}`;
                
                header.addEventListener('click', function() {
                    focusOnSubject(index);
                });
            });
            
            // Add keyboard navigation
            document.addEventListener('keydown', function(e) {
                if (e.target.tagName === 'INPUT' && (e.key === 'ArrowLeft' || e.key === 'ArrowRight')) {
                    e.preventDefault();
                    
                    if (e.key === 'ArrowLeft' && currentSubjectIndex > 0) {
                        focusOnSubject(currentSubjectIndex - 1);
                    } else if (e.key === 'ArrowRight' && currentSubjectIndex < subjects.length - 1) {
                        focusOnSubject(currentSubjectIndex + 1);
                    }
                }
                
                if (e.key === 'Escape') {
                    focusOnSubject(-1); // Return to all subjects view
                }
            });
            
            // Add event listeners for term and academic year changes
            const termSelect = document.getElementById('termSelect');
            const yearSelect = document.getElementById('yearSelect');
            
            if (termSelect && yearSelect) {
                function updateSelectedPeriod() {
                    const term = termSelect.value;
                    const academicYear = yearSelect.value;
                    
                    if (term && academicYear) {
                        // Update the selected period in settings
                        fetch('/api/update-selected-period', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                term: term,
                                academic_year: academicYear
                            })
                        })
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                console.log(`Updated selected period to ${term} ${academicYear}`);
                            } else {
                                console.error('Failed to update selected period:', data.message);
                            }
                        })
                        .catch(error => {
                            console.error('Error updating selected period:', error);
                        });
                    }
                }
                
                termSelect.addEventListener('change', updateSelectedPeriod);
                yearSelect.addEventListener('change', updateSelectedPeriod);
                
                // Update on initial load if both values are set
                updateSelectedPeriod();
            }
        });
        
        function focusOnSubject(index) {
            currentSubjectIndex = index;
            
            // Highlight the focused subject column in both frozen headers and main headers
            const allFrozenHeaders = document.querySelectorAll('.subject-header-frozen');
            const allMainHeaders = document.querySelectorAll('.subject-column');
            
            allFrozenHeaders.forEach((header, i) => {
                if (i === index) {
                    header.style.background = 'linear-gradient(135deg, #ffc107 0%, #ff6b6b 100%)';
                    header.style.transform = 'scale(1.05)';
                    header.style.boxShadow = '0 4px 8px rgba(255,193,7,0.3)';
                } else {
                    header.style.background = 'linear-gradient(135deg, #6c757d 0%, #495057 100%)';
                    header.style.transform = 'scale(1)';
                    header.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                }
            });
            
            allMainHeaders.forEach((header, i) => {
                if (i === index) {
                    header.style.backgroundColor = '#fff3cd';
                    header.style.borderLeft = '3px solid #ffc107';
                    header.style.transform = 'scale(1.02)';
                } else {
                    header.style.backgroundColor = '';
                    header.style.borderLeft = '';
                    header.style.transform = 'scale(1)';
                }
            });
            
            // Focus first input in the focused column
            if (index >= 0) {
                setTimeout(() => {
                    const firstInput = document.querySelector(`tr:nth-child(3) .subject-column:nth-child(${index + 3}) input`);
                    if (firstInput) {
                        firstInput.focus();
                        firstInput.select();
                    }
                }, 100);
            }
        }
    </script>
</body>
</html>
