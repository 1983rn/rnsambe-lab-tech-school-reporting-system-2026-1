{% extends "base.html" %}

{% block title %}Developer Dashboard - RN_LAB_TECH School System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2><i class="fas fa-code me-2"></i>Developer Dashboard</h2>
                <p class="text-muted">System Administration & School Management</p>
            </div>
            <div>
                <span class="badge bg-success fs-6">Developer Access</span>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-3">
        <div class="card text-white bg-primary">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Total Schools</h5>
                        <h2 id="totalSchools">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-school fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-success">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Active Schools</h5>
                        <h2 id="activeSchools">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-check-circle fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-warning">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">Locked Schools</h5>
                        <h2 id="lockedSchools">0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-lock fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-white bg-info">
            <div class="card-body">
                <div class="d-flex justify-content-between">
                    <div>
                        <h5 class="card-title">System Version</h5>
                        <h2>2.0</h2>
                    </div>
                    <div class="align-self-center">
                        <i class="fas fa-cogs fa-2x"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-dark text-white">
                <ul class="nav nav-tabs card-header-tabs" id="managementTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active bg-primary text-white border-primary" id="schools-tab" data-bs-toggle="tab" data-bs-target="#schools" type="button" role="tab">
                            <i class="fas fa-school me-1"></i>Schools
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link text-white" id="subscriptions-tab" data-bs-toggle="tab" data-bs-target="#subscriptions" type="button" role="tab">
                            <i class="fas fa-credit-card me-1"></i>Subscriptions
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link text-white" id="notifications-tab" data-bs-toggle="tab" data-bs-target="#notifications" type="button" role="tab">
                            <i class="fas fa-bell me-1"></i>Notifications
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="managementTabsContent">
                    <!-- Schools Tab -->
                    <div class="tab-pane fade show active" id="schools" role="tabpanel">
                        <div class="d-flex justify-content-between mb-3">
                            <h6>Registered Schools</h6>
                            <button class="btn btn-primary btn-sm" onclick="showAddSchoolModal()">
                                <i class="fas fa-plus me-1"></i>Add School
                            </button>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>School Name</th>
                                        <th>Username</th>
                                        <th>Status</th>
                                        <th>Subscription</th>
                                        <th>Days Left</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="schoolsTableBody">
                                    <!-- Schools will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Subscriptions Tab -->
                    <div class="tab-pane fade" id="subscriptions" role="tabpanel">
                        <div class="d-flex justify-content-between mb-3">
                            <h6>Subscription Management</h6>
                            <button class="btn btn-success btn-sm" onclick="sendAllReminders()">
                                <i class="fas fa-paper-plane me-1"></i>Send All Reminders
                            </button>
                        </div>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="card border-warning">
                                    <div class="card-body text-center">
                                        <h5 class="text-warning">Expiring Soon</h5>
                                        <h2 id="expiringSoon">0</h2>
                                        <small class="text-muted">â‰¤ 30 days remaining</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card border-danger">
                                    <div class="card-body text-center">
                                        <h5 class="text-danger">Expired</h5>
                                        <h2 id="expiredCount">0</h2>
                                        <small class="text-muted">Needs immediate attention</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>School Name</th>
                                        <th>Subscription Status</th>
                                        <th>Days Remaining</th>
                                        <th>End Date</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="subscriptionsTableBody">
                                    <!-- Subscriptions will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <!-- Notifications Tab -->
                    <div class="tab-pane fade" id="notifications" role="tabpanel">
                        <div class="d-flex justify-content-between mb-3">
                            <h6>Schools Requiring Attention</h6>
                            <button class="btn btn-warning btn-sm" onclick="loadSchoolsToLock()">
                                <i class="fas fa-refresh me-1"></i>Refresh
                            </button>
                        </div>
                        
                        <div class="alert alert-warning" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Action Required:</strong> The following schools have expired subscriptions and should be locked.
                        </div>
                        
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>School Name</th>
                                        <th>Username</th>
                                        <th>Days Overdue</th>
                                        <th>Expired Date</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody id="lockTableBody">
                                    <!-- Schools to lock will be loaded here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-tools me-2"></i>System Tools</h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="backupDatabase()">
                        <i class="fas fa-database me-2"></i>Backup Database
                    </button>
                    <button class="btn btn-outline-success" onclick="viewSystemLogs()">
                        <i class="fas fa-file-alt me-2"></i>View System Logs
                    </button>
                    <button class="btn btn-outline-warning" onclick="systemMaintenance()">
                        <i class="fas fa-wrench me-2"></i>System Maintenance
                    </button>
                    <a href="{{ url_for('logout') }}" class="btn btn-outline-danger">
                        <i class="fas fa-sign-out-alt me-2"></i>Logout
                    </a>
                </div>
            </div>
        </div>
        
        <div class="card mt-3">
            <div class="card-header bg-secondary text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>System Info</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li><strong>Developer:</strong> RN_LAB_TECH</li>
                    <li><strong>Version:</strong> 2.0 Web</li>
                    <li><strong>Database:</strong> SQLite</li>
                    <li><strong>Platform:</strong> Flask</li>
                    <li><strong>Standards:</strong> Ministry Compatible</li>
                </ul>
            </div>
        </div>
    </div>
</div>

<!-- Add School Modal -->
<div class="modal fade" id="addSchoolModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add New School</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addSchoolForm">
                    <div class="mb-3">
                        <label for="schoolName" class="form-label">School Name</label>
                        <input type="text" class="form-control" id="schoolName" required>
                    </div>
                    <div class="mb-3">
                        <label for="schoolUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="schoolUsername" required>
                    </div>
                    <div class="mb-3">
                        <label for="schoolPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="schoolPassword" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addSchool()">Add School</button>
            </div>
        </div>
    </div>
</div>

<!-- Grant Subscription Modal -->
<div class="modal fade" id="grantSubscriptionModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Grant Subscription</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="grantSubscriptionForm">
                    <input type="hidden" id="grantSchoolId">
                    <div class="mb-3">
                        <label for="schoolNameDisplay" class="form-label">School Name</label>
                        <input type="text" class="form-control" id="schoolNameDisplay" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="subscriptionMonths" class="form-label">Subscription Duration (Months)</label>
                        <select class="form-control" id="subscriptionMonths" required>
                            <option value="3">3 Months</option>
                            <option value="6">6 Months</option>
                            <option value="12" selected>12 Months (1 Year)</option>
                            <option value="24">24 Months (2 Years)</option>
                        </select>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" onclick="grantSubscription()">Grant Subscription</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    loadSchools();
    loadSchoolsToLock();
    
    // Handle tab switching with visual feedback
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function(e) {
            // Remove active styling from all tabs
            document.querySelectorAll('[data-bs-toggle="tab"]').forEach(t => {
                t.classList.remove('bg-primary', 'border-primary');
                t.classList.add('text-white');
            });
            // Add active styling to current tab
            e.target.classList.add('bg-primary', 'border-primary');
        });
    });
});

function loadSchools() {
    fetch('/api/developer/schools')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const tbody = document.getElementById('schoolsTableBody');
            tbody.innerHTML = '';
            
            let totalSchools = data.schools.length;
            let activeSchools = data.schools.filter(s => s.status === 'active').length;
            let lockedSchools = data.schools.filter(s => s.status === 'locked').length;
            
            document.getElementById('totalSchools').textContent = totalSchools;
            document.getElementById('activeSchools').textContent = activeSchools;
            document.getElementById('lockedSchools').textContent = lockedSchools;
            
            // Clear subscriptions table
            document.getElementById('subscriptionsTableBody').innerHTML = '';
            
            // Update subscription stats
            let expiringSoon = data.schools.filter(s => s.days_remaining <= 30 && s.days_remaining > 0).length;
            let expired = data.schools.filter(s => s.days_remaining <= 0).length;
            
            document.getElementById('expiringSoon').textContent = expiringSoon;
            document.getElementById('expiredCount').textContent = expired;
            
            data.schools.forEach(school => {
                // Schools table
                const row = document.createElement('tr');
                const statusBadge = school.status === 'active' ? 
                    '<span class="badge bg-success">Active</span>' : 
                    '<span class="badge bg-warning">Locked</span>';
                
                const subscriptionBadge = school.subscription_status === 'paid' ? 
                    '<span class="badge bg-success">Paid</span>' : 
                    '<span class="badge bg-warning">Trial</span>';
                
                const daysRemaining = school.days_remaining || 0;
                const daysClass = daysRemaining <= 0 ? 'text-danger' : daysRemaining <= 30 ? 'text-warning' : 'text-success';
                
                row.innerHTML = `
                    <td><strong>${school.school_name}</strong></td>
                    <td>${school.username}</td>
                    <td>${statusBadge}</td>
                    <td>${subscriptionBadge}</td>
                    <td><span class="${daysClass}">${daysRemaining} days</span></td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-success" onclick="showGrantSubscriptionModal(${school.school_id}, '${school.school_name}')" title="Grant Subscription">
                                <i class="fas fa-credit-card"></i>
                            </button>
                            <button class="btn btn-outline-secondary" onclick="resetSchoolCredentials(${school.school_id}, '${school.school_name}')" title="Reset Credentials">
                                <i class="fas fa-key"></i>
                            </button>
                            <button class="btn btn-outline-warning" onclick="toggleSchoolStatus(${school.school_id}, '${school.status}')" title="${school.status === 'active' ? 'Lock' : 'Unlock'}">
                                <i class="fas fa-${school.status === 'active' ? 'lock' : 'unlock'}"></i>
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteSchool(${school.school_id})" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
                
                // Subscriptions table
                const subTbody = document.getElementById('subscriptionsTableBody');
                if (!subTbody.querySelector(`[data-school-id="${school.school_id}"]`)) {
                    const subRow = document.createElement('tr');
                    subRow.setAttribute('data-school-id', school.school_id);
                    
                    const endDate = school.subscription_end_date ? 
                        new Date(school.subscription_end_date).toLocaleDateString() : 'N/A';
                    
                    subRow.innerHTML = `
                        <td><strong>${school.school_name}</strong></td>
                        <td>${subscriptionBadge}</td>
                        <td><span class="${daysClass}">${daysRemaining} days</span></td>
                        <td>${endDate}</td>
                        <td>
                            <button class="btn btn-success btn-sm" onclick="showGrantSubscriptionModal(${school.school_id}, '${school.school_name}')">
                                <i class="fas fa-plus me-1"></i>Extend
                            </button>
                        </td>
                    `;
                    subTbody.appendChild(subRow);
                }
            });
        }
    })
    .catch(error => {
        console.error('Error loading schools:', error);
    });
}

function showAddSchoolModal() {
    new bootstrap.Modal(document.getElementById('addSchoolModal')).show();
}

function addSchool() {
    const schoolName = document.getElementById('schoolName').value;
    const username = document.getElementById('schoolUsername').value;
    const password = document.getElementById('schoolPassword').value;
    
    if (!schoolName || !username || !password) {
        alert('Please fill in all fields');
        return;
    }
    
    fetch('/api/developer/add-school', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            school_name: schoolName,
            username: username,
            password: password
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('addSchoolModal')).hide();
            document.getElementById('addSchoolForm').reset();
            loadSchools();
            alert('School added successfully');
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error adding school: ' + error.message);
    });
}

function toggleSchoolStatus(schoolId, currentStatus) {
    const newStatus = currentStatus === 'active' ? 'locked' : 'active';
    const action = newStatus === 'locked' ? 'lock' : 'unlock';
    
    if (confirm(`Are you sure you want to ${action} this school?`)) {
        fetch('/api/developer/update-school-status', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                school_id: schoolId,
                status: newStatus
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadSchools();
                alert(`School ${action}ed successfully`);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error updating school status: ' + error.message);
        });
    }
}

function deleteSchool(schoolId) {
    if (confirm('Are you sure you want to delete this school? This action cannot be undone.')) {
        fetch('/api/developer/delete-school', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                school_id: schoolId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                loadSchools();
                alert('School deleted successfully');
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error deleting school: ' + error.message);
        });
    }
}

function resetSchoolCredentials(schoolId, schoolName) {
    if (!confirm(`Reset credentials for ${schoolName}? This will generate a temporary password that the school must change on first login.`)) return;
    fetch('/api/developer/reset-school-credentials', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({ school_id: schoolId })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show the temporary password to the developer so they can share securely with the school
            alert(`Temporary password for ${schoolName}: ${data.temporary_password}\n\nShare this securely. The school will be forced to change it on their next login.`);
            loadSchools();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error resetting credentials: ' + error.message);
    });
}

function backupDatabase() {
    alert('Database backup feature will be implemented');
}

function viewSystemLogs() {
    alert('System logs viewer will be implemented');
}

function systemMaintenance() {
    alert('System maintenance tools will be implemented');
}

function showGrantSubscriptionModal(schoolId, schoolName) {
    document.getElementById('grantSchoolId').value = schoolId;
    document.getElementById('schoolNameDisplay').value = schoolName;
    new bootstrap.Modal(document.getElementById('grantSubscriptionModal')).show();
}

function grantSubscription() {
    const schoolId = document.getElementById('grantSchoolId').value;
    const months = document.getElementById('subscriptionMonths').value;
    
    fetch('/api/developer/grant-subscription', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            school_id: parseInt(schoolId),
            months: parseInt(months)
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('grantSubscriptionModal')).hide();
            loadSchools();
            alert(data.message);
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        alert('Error granting subscription: ' + error.message);
    });
}

function sendAllReminders() {
    if (confirm('Send subscription reminders to all schools with expiring subscriptions?')) {
        fetch('/api/developer/send-reminders', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            alert('Error sending reminders: ' + error.message);
        });
    }
}

function loadSchoolsToLock() {
    fetch('/api/developer/schools-to-lock')
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const tbody = document.getElementById('lockTableBody');
            tbody.innerHTML = '';
            
            if (data.schools.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No schools require locking at this time</td></tr>';
                return;
            }
            
            data.schools.forEach(school => {
                const row = document.createElement('tr');
                const daysOverdue = Math.abs(school.days_remaining);
                const expiredDate = school.subscription_end_date ? 
                    new Date(school.subscription_end_date).toLocaleDateString() : 'N/A';
                
                row.innerHTML = `
                    <td><strong>${school.school_name}</strong></td>
                    <td>${school.username}</td>
                    <td><span class="text-danger">${daysOverdue} days</span></td>
                    <td>${expiredDate}</td>
                    <td>
                        <button class="btn btn-warning btn-sm" onclick="toggleSchoolStatus(${school.school_id}, 'active')">
                            <i class="fas fa-lock me-1"></i>Lock Now
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
    })
    .catch(error => {
        console.error('Error loading schools to lock:', error);
    });
}
</script>
{% endblock %}